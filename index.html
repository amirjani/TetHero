<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #line-chart {
            display: block;
            width: 100%;
        }
    </style>
</head>

<style>
    .query-params {
        margin: 1rem auto;
    }
</style>

<body>
    <div class="query-params">
        <label for="candle">Choose a Candle:</label>
        <select name="candle" id="candle">
            <option value="5">5 minutes</option>
            <option value="10">10 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">60 minutes</option>
            <option value="1440">24 hours</option>
        </select>

        <label for="source">Choose a Source:</label>

        <select name="source" id="price-source">
            <option value="afratether">Afra Tether</option>
            <option value="nobitex">Nobitex</option>
            <option value="wallex">Wallex</option>
            <option value="arzinja">Arzinja</option>
            <option value="changekon">Changekon</option>
            <option value="abantether">Aban Tether</option>
            <option value="phinix">Phinix</option>
            <option value="coinnik">Coinnik</option>
            <option value="jibitex">Jibitex</option>
            <option value="arzpaya">Arzpaya</option>
            <option value="bitpin">Bitpin</option>
            <option value="ramzinex">Ramzinex</option>
            <option value="exir">Exir</option>
            <option value="exnovin">Exnovin</option>
            <option value="bittestan">Bittestan</option>
            <option value="salam-crypto">salam-crypto</option>
            <option value="OnPay">OnPay</option>
        </select>

        <label for="from">from date:</label>
        <input type="date" id="from" name="from">

        <label for="to">to date:</label>
        <input type="date" id="to" name="to">

    </div>


    <canvas id="line-chart"></canvas>
    <canvas id="line-chart-all"></canvas>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.0"></script>
    <script src="./Pricing-TokenBaz.js"></script> -->

    <script>
        var groupBy = function(xs, key) {
            return xs.reduce(function(rv, x) {
                (rv[x[key]] = rv[x[key]] || []).push(x);
                return rv;
            }, {});
        };
        const ctxAll = document.querySelector("#line-chart-all").getContext('2d');
        ctxAll.canvas.width = 1000;
        ctxAll.canvas.height = 200;
        // const groupedData = groupBy(data,'source');

        fetch("http://localhost:3000/api/pricing/last-day")
        .then(async response => {
            const jsonResponse = await response.json()
            const prices = jsonResponse.data.map(item => {
                const color = `${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}`
                
                const sortedData = item.buyChart
                const line = {
                    data: sortedData,
                    label: item.source,
                    borderColor: "#3e95cd",
                    
                    fill: false,
                    backgroundColor: [
                        `rgba(${color}, 1)`
                    ],
                    borderColor: [
                        `rgba(${color}, 1)`
                    ],
                    borderWidth: 2,
                    lineTension: 0.500
                }
                return line;
            })
            const config = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: prices
                },
                options: {
                    elements: {
                        point:{
                            radius: 0
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            }
                        }
                    },
                    scales: {
                    }
                }
            };
            new Chart(ctxAll, config);
        })
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.26.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.1/dist/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="./chartjs-chart-financial.js" type="text/javascript"></script>
    <script>
        var ctx = document.getElementById('line-chart').getContext('2d');
        ctx.canvas.width = 1000;
        ctx.canvas.height = 200;

        var barData = [];
        var chart = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: 'CHRT - Chart.js Corporation',
                    data: barData
                }]
            },
            options: {
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'xy',
                        }
                    }
                },
            }
        });
        
        const sourceSelectBox = document.getElementById("price-source")
        const candleSelectBox = document.getElementById("candle")
        
        const fromDate = document.getElementById("from")
        const toDate = document.getElementById("to")
        
        candleSelectBox.addEventListener('change', e => {
            fetchData();
        });

        sourceSelectBox.addEventListener("change", () => {
            fetchData();
        });

        fromDate.addEventListener('change', e => {
            console.log(fromDate.value);
            fetchData();
        });

        toDate.addEventListener('change', e => {
            console.log(toDate.value);
            fetchData();
        });

        fetchData();


        function updateChart() {

            chart.config.data.datasets = [
                {
                    data: barData
                }
            ]

            chart.update();
        };

        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function fetchData() {
            const candle = candleSelectBox.value || 15;
            const source = sourceSelectBox.value || "OnPay"
            const from = (fromDate.value || moment().format('YYYY-MM-DD')) + ' 00:00';
            const to = (toDate.value || moment().format('YYYY-MM-DD')) + ' 23:59';
            fetch("http://localhost:3000/api/pricing/last-day-candle" + `?candle=${candle}&source=${source}&from=${from}&to=${to}`)
                .then(async response => {
                    const jsonResponse = await response.json()

                    // START FINANCIAL CHART
                   


                    barData = jsonResponse.data.map(item => {
                        var DATE_RFC2822 = "DD MMM YYYY HH:mm";
                        return {
                            // moment(item.x).toDate()
                            x: luxon.DateTime.fromRFC2822(moment(item.x).format(DATE_RFC2822) + " Z").valueOf(),
                            o: item.open,
                            h: item.max,
                            l: item.min,
                            c: item.close
                        };
                    })
                
                    function lineData() { return barData.map(d => { return { x: d.x, y: d.c } }) };

                    
                    updateChart()
            
                    // END FINANCIAL CHART
                })

        }

    </script>
</body>

</html>